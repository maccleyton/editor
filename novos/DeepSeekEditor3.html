<!doctype html>
<html lang="pt-br">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Cosmos MD — Editor Markdown + LaTeX (A4, PDF, HTML/MD)</title>
	<style>
	  :root{
		--bg: #0f172a; --panel: #0b1229; --text: #e2e8f0; --muted: #94a3b8;
		--border: #233164; --accent: #60a5fa; --button: #1e293b; --shadow: rgba(0,0,0,.35);
		--a4-bg: #0a0f1f; --page-bg: #ffffff; --code-bg: #0b1020;
	  }
	  .light{
		--bg: #f8fafc; --panel: #ffffff; --text: #0f172a; --muted: #475569;
		--border: #e2e8f0; --accent: #2563eb; --button: #f1f5f9; --shadow: rgba(0,0,0,.08);
		--a4-bg: #eef2ff; --page-bg: #ffffff; --code-bg: #0f172a;
	  }

	  html, body { height: 100%; }
	  body { margin:0; background:var(--bg); color:var(--text);
		font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans"; }
	  .app{ display:flex; flex-direction:column; height:100%; }

	  header{ display:flex; align-items:center; gap:.5rem; flex-wrap:wrap;
		padding:.6rem .8rem; background:var(--panel); border-bottom:1px solid var(--border);
		position:sticky; top:0; z-index:10; }
	  .brand{ font-weight:800; letter-spacing:.3px; margin-right:.5rem; }
	  .toolbar{ display:flex; flex-wrap:wrap; gap:.25rem; }
	  button, .seg{ border:1px solid var(--border); background:var(--button); color:var(--text);
		padding:.45rem .6rem; border-radius:.5rem; cursor:pointer; }
	  button:hover{ outline:1px solid var(--accent); }
	  .seg{ display:inline-flex; gap:.25rem; align-items:center; }
	  .grow{ flex:1 1 auto; }
	  .toggles{ display:flex; gap:.4rem; align-items:center; flex-wrap:wrap; }
	  label{ color:var(--muted); font-size:.9rem; }

	  main{ flex:1 1 auto; display:flex; min-height:0; gap:.75rem; padding:.75rem; }
	  .pane{ flex:1; display:flex; flex-direction:column; min-width:0;
		background:var(--panel); border:1px solid var(--border);
		border-radius:.75rem; overflow:hidden; }
	  .pane h3{ margin:0; padding:.5rem .75rem; border-bottom:1px solid var(--border);
		font-size:.9rem; color:var(--muted); background: linear-gradient(to bottom, rgba(255,255,255,0.02), transparent); }
	  textarea{ flex:1; resize:none; padding:1rem; border:0; outline:0; background:transparent; color:var(--text);
		font: 13px/1.55 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace; tab-size:2; }
	  .status{ display:flex; gap:1rem; align-items:center; justify-content:space-between;
		padding:.35rem .75rem; border-top:1px solid var(--border); color:var(--muted); font-size:.85rem; }
	  .preview{ flex:1; overflow:auto; padding:1rem; }

	  .content{ max-width: 58rem; margin: 0 auto; }
	  .content h1, .content h2, .content h3, .content h4, .content h5, .content h6{ margin:1em 0 .5em; line-height:1.22; }
	  .content h1{ font-size:1.9rem; } .content h2{ font-size:1.6rem; } .content h3{ font-size:1.34rem; }
	  .content p{ margin:.7em 0; }
	  .content code{ background:rgba(148,163,184,.15); padding:.1rem .3rem; border-radius:.3rem; }
	  .content pre{ background: var(--code-bg); color:#e2e8f0; border:1px solid var(--border);
		padding:.85rem; border-radius:.6rem; overflow:auto; }
	  .light .content pre{ color:#e2e8f0; }
	  .content blockquote{ margin: .8rem 0; padding: .6rem .9rem;
		border-left: 4px solid var(--accent); background: rgba(96,165,250,.08); }
	  .content ul, .content ol{ padding-left: 1.3rem; }
	  .content li.task > input[type="checkbox"]{ margin-right:.45rem; vertical-align:middle; }
	  .content hr{ border:0; border-top:1px solid var(--border); margin:1rem 0; }
	  .content img{ max-width:100%; border-radius:.35rem; border:1px solid var(--border); background:#fff; }
	  .content table{ border-collapse: collapse; width:100%; margin:.8rem 0; }
	  .content th, .content td{ border:1px solid var(--border); padding:.45rem .5rem; }
	  .content thead th{ background: rgba(96,165,250,.12); }
	  .content a{ color: var(--accent); text-decoration: none; }
	  .content a:hover{ text-decoration: underline; }

	  .admonition{ border:1px solid var(--border); border-left-width:4px; padding:.75rem .9rem; border-radius:.5rem; margin:.9rem 0; }
	  .admonition .ad-title{ font-weight:700; margin-bottom:.4rem; }
	  .admonition.note{ border-left-color:#3b82f6; background:rgba(59,130,246,.08); }
	  .admonition.warning{ border-left-color:#f59e0b; background:rgba(245,158,11,.08); }
	  .admonition.info{ border-left-color:#06b6d4; background:rgba(6,182,212,.08); }
	  .admonition.tip{ border-left-color:#10b981; background:rgba(16,185,129,.08); }

	  .a4-surface{ background: var(--a4-bg); padding: 1rem; border-radius:.6rem; }
	  .pages{ display:flex; flex-direction:column; gap: 1rem; align-items:center; }
	  .page{ width: 210mm; height: 297mm; background: var(--page-bg); color: #111827;
		box-shadow: 0 10px 30px var(--shadow); border-radius:.2rem; position:relative; overflow:hidden; }
	  .page-inner{ box-sizing:border-box; padding: 18mm; width:100%; height:100%; overflow:auto; }
	  .page-inner .mjx-container{ color:#111827; }

	  /* Controle de margem inferior e quebras de página */
	  .page-inner h1, .page-inner h2, .page-inner table, .page-inner pre, .page-inner blockquote, .page-inner ul, .page-inner ol {
		break-inside: avoid; page-break-inside: avoid;
	  }

	  @media print{
		@page{ size: A4; margin: 0; }
		header, .left-pane{ display:none !important; }
		main{ padding:0; } .preview{ padding:0; }
		.a4-surface{ padding:0; background:white; }
		.page{ box-shadow:none; border-radius:0; page-break-after: always; }
		.page:last-child{ page-break-after: auto; }
	  }

	  .kbd{ background:rgba(148,163,184,.15); padding:.05rem .3rem; border-radius:.25rem; border:1px solid var(--border); font-size:.85em; }

	  .modal{ position: fixed; inset:0; background: rgba(0,0,0,.45);
		display:none; align-items:center; justify-content:center; z-index:1000; }
	  .modal.open{ display:flex; }
	  .modal-card{ width:min(800px, 92vw); background: var(--panel); border:1px solid var(--border);
		border-radius:.75rem; box-shadow: 0 15px 40px rgba(0,0,0,.45);
		display:flex; flex-direction:column; overflow:hidden; }
	  .modal-card header{ position:static; border-bottom:1px solid var(--border);
		background: linear-gradient(to bottom, rgba(255,255,255,0.02), transparent); }
	  .modal-body{ display:flex; gap:.75rem; padding:.75rem; }
	  .modal-body textarea{ height:220px; width:100%; background:transparent; color:var(--text);
		border:1px solid var(--border); border-radius:.5rem; padding:.6rem; }
	  .modal-side{ flex:1; border:1px solid var(--border); border-radius:.5rem; padding:.6rem; overflow:auto;
		background:rgba(148,163,184,.08); }
	  .modal-footer{ display:flex; justify-content:space-between; padding:.6rem .75rem; border-top:1px solid var(--border); }
	  .modal small{ color:var(--muted); }
	</style>

	<!-- MathJax config ANTES da lib -->
	<script>
	  window.MathJax = {
		tex: { 
		  inlineMath: [['$', '$'], ['\\(', '\\)']], 
		  displayMath: [['$$','$$'], ['\\[','\\]']], 
		  processEscapes: true, 
		  tags: 'none' 
		},
		options: { 
		  skipHtmlTags: {'[-]': ['code','pre','script','style','textarea']} 
		},
		chtml: { scale: 1.0, matchFontHeight: false }
	  };
	</script>
	<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>

<body class="light">
<div class="app">
  <header>
    <div class="brand">Cosmos MD ✨</div>
    <div class="toolbar">
      <span class="seg">
        <button data-action="bold" title="Negrito (Ctrl+B)">🅱️</button>
        <button data-action="italic" title="Itálico (Ctrl+I)">📝️</button>
        <button data-action="code" title="Código inline (Ctrl+`)">🧑‍💻</button>
      </span>
      <span class="seg">
        <button data-action="h1" title="Título 1">🔠</button>
        <button data-action="h2" title="Título 2">🔡</button>
        <button data-action="h3" title="Título 3">🔤</button>
      </span>
      <span class="seg">
        <button data-action="ul" title="Lista não ordenada">📋</button>
        <button data-action="ol" title="Lista ordenada">🔢</button>
        <button data-action="task" title="Checklist">☑️</button>
        <button data-action="quote" title="Citação">💬</button>
        <button data-action="hr" title="Linha horizontal">➖</button>
      </span>
      <span class="seg">
        <button data-action="link" title="Link">🔗</button>
        <button data-action="image" title="Imagem">🖼️</button>
        <button data-action="fence" title="Bloco de código">📦</button>
        <button data-action="table" title="Tabela">📊</button>
      </span>
      <span class="seg"><button title="Editor de LaTeX" id="latexBtn">🧮 LaTeX</button></span>
    </div>
    <div class="grow"></div>
    <div class="toggles">
      <label><input type="checkbox" id="autoRender" checked> render LaTeX</label>
      <button id="themeBtn" title="Alternar tema">🌗</button>
      <button id="exportPDF">Exportar PDF</button>
      <button id="exportHTML">Exportar HTML</button>
      <button id="downloadMD">Baixar .md</button>
    </div>
  </header>

  <main>
    <section class="pane left-pane">
      <h3>Editor (Markdown) — arraste imagens aqui</h3>
      <textarea id="editor" spellcheck="false" placeholder="# Bem-vindo(a) ao Cosmos MD

Digite **Markdown** aqui. Matemática inline: $E=mc^2$.
Matemática em bloco:

$$
\\int_0^1 x^2\\,dx = \\tfrac{1}{3}
$$

- [ ] Checklist desmarcada
- [x] Checklist marcada

::: note
**Nota**: Este é um bloco *admonition*.
:::

| Cabeçalho Esquerda | Cabeçalho Centro | Cabeçalho Direita |
|:-------------------|:----------------:|------------------:|
| Dado A1            | Dado B1          | Dado C1           |
| Dado A2            | Dado B2          | Dado C2           |

[Link de exemplo](https://exemplo.com)
"></textarea>
      <div class="status">
        <div id="cursorInfo">Lin 1, Col 1</div>
        <div id="countInfo">0 caracteres</div>
      </div>
    </section>

    <section class="pane">
      <h3>Visualização (A4)</h3>
      <div id="preview" class="preview">
        <div class="a4-surface"><div class="pages" id="pages"></div></div>
      </div>
      <div class="status">
        <div>Render em tempo real <span class="kbd">300ms</span></div>
        <div>LaTeX via MathJax</div>
      </div>
    </section>
  </main>
</div>

<!-- Modal LaTeX -->
<div class="modal" id="latexModal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="latexTitle">
    <header><div class="brand" id="latexTitle">Editor de LaTeX</div></header>
    <div class="modal-body">
      <div style="flex:1; display:flex; flex-direction:column; gap:.4rem;">
        <label><small>Expressão LaTeX</small></label>
        <textarea id="latexInput" placeholder="Ex.: \\int_0^1 x^2\\,dx"></textarea>
        <div style="display:flex; gap:.5rem; align-items:center;">
          <label><input type="radio" name="latexKind" value="inline" checked> inline <span class="kbd">$...$</span></label>
          <label><input type="radio" name="latexKind" value="block"> bloco <span class="kbd">$$...$$</span></label>
          <label><input type="checkbox" id="latexPreviewToggle" checked> pré-visualizar</label>
        </div>
      </div>
      <div class="modal-side">
        <div><small>Prévia:</small></div>
        <div id="latexPreview" style="padding-top:.4rem;"></div>
      </div>
    </div>
    <div class="modal-footer">
      <div style="display:flex; gap:.5rem;">
        <button id="latexInsert">Inserir/Atualizar</button>
        <button id="latexCancel">Fechar</button>
      </div>
      <small>Dica: selecione um texto no editor para sobrescrever. O preview usa MathJax.</small>
    </div>
  </div>
</div>

<script>
/* ====== Utilidades / Estado ====== */
function $(s){ return document.querySelector(s); }
function $$(s){ return document.querySelectorAll(s); }
var editor = $('#editor'), pages = $('#pages'), autoRender = $('#autoRender'), themeBtn = $('#themeBtn');
var STORAGE_KEY = 'cosmos-md-doc-v2'; var THEME_KEY = 'cosmos-md-theme-v2';

function debounce(fn, w){ 
  var t; w=w||300; 
  return function(){ 
    var a=arguments; 
    clearTimeout(t); 
    t=setTimeout(function(){ fn.apply(null,a); }, w); 
  }; 
}

function setCaretInfo(){ 
  var val=editor.value, pos=editor.selectionStart||0, before=val.slice(0,pos), lines=before.split('\n'); 
  $('#cursorInfo').textContent='Lin '+lines.length+', Col '+(lines[lines.length-1].length+1); 
}

function setCountInfo(){ 
  $('#countInfo').textContent = editor.value.length + ' caracteres'; 
}

function escapeHtml(s){ 
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); 
}

function safeUrl(u, allowData){ 
  try{ 
    var s=String(u).trim(); 
    if(allowData && s.indexOf('data:')===0) return s; 
    if(/^https?:\/\//i.test(s) || /^mailto:/i.test(s)) return s; 
  }catch(e){} 
  return '#'; 
}

/* ====== Parser Markdown Corrigido ====== */
function mdToHtml(md){
  md = String(md).replace(/\r\n?/g,'\n');
  
  // Processar blocos de código primeiro
  var fences = [];
  md = md.replace(/```([a-z0-9+_-]*)\n?([\s\S]*?)```/gi, function(m, lang, code){
    var idx = fences.length;
    fences.push({ lang: (lang || '').trim(), code: code });
    return '\u0000FENCE_' + idx + '\u0000';
  });

  // Processar tabelas - CORREÇÃO PRINCIPAL
  md = md.replace(/(\|[^\n]+\|\r?\n)((?:\|[\s\:-]+)+\|\r?\n)((?:\|[^\n]+\|\r?\n?)+)/g, function(m, header, separator, body){
    // Processar linha de separação para determinar alinhamento
    var alignCells = separator.trim().split('|').slice(1, -1);
    var aligns = alignCells.map(function(cell){
      cell = cell.trim();
      if (/^:-+:$/.test(cell)) return 'center';
      if (/^-+:$/.test(cell)) return 'right';
      if (/^:-+$/.test(cell)) return 'left';
      return 'left';
    });
    
    // Processar cabeçalho
    var headerCells = header.trim().split('|').slice(1, -1).map(function(cell){ 
      return cell.trim(); 
    });
    
    // Processar linhas do corpo
    var bodyRows = body.trim().split('\n').map(function(row){
      return row.trim().split('|').slice(1, -1).map(function(cell){ 
        return cell.trim(); 
      });
    });
    
    // Construir HTML da tabela
    var html = '<table><thead><tr>';
    
    // Cabeçalhos
    headerCells.forEach(function(cell, i){
      html += '<th style="text-align:' + (aligns[i] || 'left') + '">' + inlineParse(cell) + '</th>';
    });
    html += '</tr></thead><tbody>';
    
    // Linhas do corpo
    bodyRows.forEach(function(row){
      if (row.length === headerCells.length) {
        html += '<tr>';
        row.forEach(function(cell, i){
          html += '<td style="text-align:' + (aligns[i] || 'left') + '">' + inlineParse(cell) + '</td>';
        });
        html += '</tr>';
      }
    });
    
    html += '</tbody></table>';
    return html;
  });

  // Processar admonitions
  md = md.replace(/^:::\s*(\w+)\s*\n([\s\S]*?)\n:::\s*$/gm, function(m, type, content){
    return '<div class="admonition ' + type + '"><div class="ad-title">' + 
           type.toUpperCase() + '</div>' + blockParse(content.trim()) + '</div>';
  });

  // Processar por linhas
  var lines = md.split('\n');
  var output = [];
  var i = 0;
  var paragraphBuffer = [];

  function flushParagraph(){
    if (paragraphBuffer.length > 0) {
      var text = paragraphBuffer.join(' ').trim();
      if (text) {
        output.push('<p>' + inlineParse(text) + '</p>');
      }
      paragraphBuffer = [];
    }
  }

  function parseList(startIndex, listType){
    var items = [];
    var j = startIndex;
    
    while (j < lines.length) {
      var line = lines[j];
      var listRegex = listType === 'ol' ? /^\d+\.\s+(.*)/ : /^[-*+]\s+(.*)/;
      var match = line.match(listRegex);
      
      if (match) {
        // Verificar se é checklist
        var taskMatch = match[1].match(/^\[([ x])\]\s+(.*)/i);
        if (taskMatch) {
          var checked = taskMatch[1].toLowerCase() === 'x';
          items.push('<li class="task"><input type="checkbox"' + (checked ? ' checked' : '') + 
                    ' disabled> ' + inlineParse(taskMatch[2]) + '</li>');
        } else {
          items.push('<li>' + inlineParse(match[1]) + '</li>');
        }
        j++;
      } else {
        break;
      }
    }
    
    var tag = listType === 'ol' ? 'ol' : 'ul';
    return { html: '<' + tag + '>' + items.join('') + '</' + tag + '>', nextIndex: j };
  }

  while (i < lines.length) {
    var line = lines[i];
    
    if (/^\s*$/.test(line)) {
      flushParagraph();
      output.push('');
      i++;
      continue;
    }

    // Headers
    var headerMatch = line.match(/^(#{1,6})\s+(.*)/);
    if (headerMatch) {
      flushParagraph();
      var level = headerMatch[1].length;
      var text = headerMatch[2];
      output.push('<h' + level + '>' + inlineParse(text) + '</h' + level + '>');
      i++;
      continue;
    }

    // Blockquotes
    if (/^>\s+(.*)/.test(line)) {
      flushParagraph();
      var quoteLines = [];
      while (i < lines.length && /^>\s+(.*)/.test(lines[i])) {
        quoteLines.push(lines[i].replace(/^>\s+/, ''));
        i++;
      }
      output.push('<blockquote>' + quoteLines.map(inlineParse).join('<br>') + '</blockquote>');
      continue;
    }

    // Listas
    if (/^[-*+]\s+/.test(line) || /^\d+\.\s+/.test(line)) {
      flushParagraph();
      var listType = /^\d+\.\s+/.test(line) ? 'ol' : 'ul';
      var listResult = parseList(i, listType);
      output.push(listResult.html);
      i = listResult.nextIndex;
      continue;
    }

    // Horizontal rule
    if (/^[-*_]{3,}\s*$/.test(line)) {
      flushParagraph();
      output.push('<hr>');
      i++;
      continue;
    }

    // Linha normal - adicionar ao parágrafo
    paragraphBuffer.push(line);
    i++;
  }

  flushParagraph();

  var html = output.join('\n');

  // Restaurar blocos de código
  html = html.replace(/\u0000FENCE_(\d+)\u0000/g, function(m, idx){
    var fence = fences[Number(idx)];
    var langClass = fence.lang ? ' class="language-' + escapeHtml(fence.lang) + '"' : '';
    return '<pre><code' + langClass + '>' + escapeHtml(fence.code) + '</code></pre>';
  });

  return html;
}

function blockParse(text){
  return mdToHtml(text);
}

function inlineParse(text){
  // Escape HTML primeiro
  text = escapeHtml(text);
  
  // Código inline
  text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
  
  // Links
  text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, function(m, text, url){
    return '<a href="' + safeUrl(url, false) + '" target="_blank">' + text + '</a>';
  });
  
  // Imagens
  text = text.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(m, alt, src){
    return '<img src="' + safeUrl(src, true) + '" alt="' + alt + '" style="max-width:100%">';
  });
  
  // Ênfase
  text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
  text = text.replace(/\*([^*]+)\*/g, '<em>$1</em>');
  text = text.replace(/__([^_]+)__/g, '<strong>$1</strong>');
  text = text.replace(/_([^_]+)_/g, '<em>$1</em>');
  
  // Tachado
  text = text.replace(/~~([^~]+)~~/g, '<del>$1</del>');
  
  // Quebras de linha
  text = text.replace(/\n/g, '<br>');
  
  return text;
}

/* ====== Paginação A4 Corrigida ====== */
function paginateToA4(html){
  pages.innerHTML = '';
  
  var tempDiv = document.createElement('div');
  tempDiv.className = 'content';
  tempDiv.innerHTML = html;
  
  var currentPage = createPage();
  pages.appendChild(currentPage.wrap);
  
  var pageHeight = currentPage.inner.offsetHeight;
  var currentHeight = 0;
  
  function shouldBreakBefore(node){
    return node.nodeType === 1 && 
           (node.tagName === 'H1' || node.tagName === 'H2');
  }
  
  function processNode(node){
    if (!node) return;
    
    var nodeClone = node.cloneNode(true);
    var testDiv = document.createElement('div');
    testDiv.appendChild(nodeClone);
    currentPage.inner.appendChild(testDiv);
    
    var nodeHeight = testDiv.offsetHeight;
    currentPage.inner.removeChild(testDiv);
    
    // Se é um elemento que deve quebrar antes e já tem conteúdo na página
    if (shouldBreakBefore(node) && currentHeight > 50) {
      currentPage = createPage();
      pages.appendChild(currentPage.wrap);
      currentHeight = 0;
    }
    
    // Se o nó não cabe na página atual, criar nova página
    if (currentHeight + nodeHeight > pageHeight - 40 && currentHeight > 0) {
      currentPage = createPage();
      pages.appendChild(currentPage.wrap);
      currentHeight = 0;
    }
    
    currentPage.inner.appendChild(node.cloneNode(true));
    currentHeight += nodeHeight;
  }
  
  // Processar todos os nós
  while (tempDiv.firstChild) {
    var node = tempDiv.firstChild;
    tempDiv.removeChild(node);
    processNode(node);
  }
}

function createPage(){
  var wrap = document.createElement('div');
  wrap.className = 'page';
  
  var inner = document.createElement('div');
  inner.className = 'page-inner content';
  wrap.appendChild(inner);
  
  return { wrap: wrap, inner: inner };
}

/* ====== Render Principal ====== */
var render = debounce(function(){
  try{
    localStorage.setItem(STORAGE_KEY, editor.value);
    var html = mdToHtml(editor.value || '');
    paginateToA4(html);
    
    if(autoRender.checked && window.MathJax && MathJax.typesetPromise){
      MathJax.typesetPromise([pages]).catch(function(err){
        console.log('MathJax error:', err);
      });
    }
    
    setCountInfo();
  }catch(e){ 
    console.error('Erro no render:', e); 
  }
}, 300);

/* ====== Funcionalidades do Editor ====== */
function wrapSelection(prefix, suffix, placeholder){
  suffix = suffix || prefix;
  placeholder = placeholder || '';
  
  var start = editor.selectionStart;
  var end = editor.selectionEnd;
  var selected = editor.value.substring(start, end) || placeholder;
  
  var before = editor.value.substring(0, start);
  var after = editor.value.substring(end);
  
  editor.value = before + prefix + selected + suffix + after;
  
  var newCursor = start + prefix.length + selected.length;
  editor.setSelectionRange(newCursor, newCursor);
  editor.focus();
  render();
}

function insertLine(prefix){
  var start = editor.selectionStart;
  var lineStart = editor.value.lastIndexOf('\n', start - 1) + 1;
  
  var before = editor.value.substring(0, lineStart);
  var after = editor.value.substring(lineStart);
  
  editor.value = before + prefix + after;
  
  var newCursor = lineStart + prefix.length;
  editor.setSelectionRange(newCursor, newCursor);
  editor.focus();
  render();
}

// Conectar botões da toolbar
$$('button[data-action]').forEach(function(btn){
  btn.addEventListener('click', function(){
    var action = btn.dataset.action;
    switch(action){
      case 'bold': wrapSelection('**', '**', 'texto em negrito'); break;
      case 'italic': wrapSelection('*', '*', 'texto em itálico'); break;
      case 'code': wrapSelection('`', '`', 'código'); break;
      case 'h1': insertLine('# '); break;
      case 'h2': insertLine('## '); break;
      case 'h3': insertLine('### '); break;
      case 'ul': insertLine('- '); break;
      case 'ol': insertLine('1. '); break;
      case 'task': insertLine('- [ ] '); break;
      case 'quote': insertLine('> '); break;
      case 'hr': 
        var start = editor.selectionStart;
        var before = editor.value.substring(0, start);
        var after = editor.value.substring(start);
        editor.value = before + '\n---\n' + after;
        editor.setSelectionRange(start + 5, start + 5);
        editor.focus();
        render();
        break;
      case 'link': wrapSelection('[', '](https://)', 'texto do link'); break;
      case 'image': wrapSelection('![', '](https://)', 'texto alternativo'); break;
      case 'fence': 
        wrapSelection('```\n', '\n```', '// seu código aqui'); 
        break;
      case 'table':
        var table = '\n| Coluna 1 | Coluna 2 | Coluna 3 |\n|----------|----------|----------|\n| Dado 1   | Dado 2   | Dado 3   |\n';
        var start = editor.selectionStart;
        var before = editor.value.substring(0, start);
        var after = editor.value.substring(start);
        editor.value = before + table + after;
        editor.setSelectionRange(start + table.length, start + table.length);
        editor.focus();
        render();
        break;
    }
  });
});

// Atalhos de teclado
editor.addEventListener('keydown', function(e){
  if(e.ctrlKey){
    switch(e.key.toLowerCase()){
      case 'b': e.preventDefault(); wrapSelection('**', '**', 'texto'); break;
      case 'i': e.preventDefault(); wrapSelection('*', '*', 'texto'); break;
      case '`': e.preventDefault(); wrapSelection('`', '`', 'código'); break;
    }
  }
});

// Arrastar e soltar imagens
editor.addEventListener('dragover', function(e){ e.preventDefault(); });
editor.addEventListener('drop', function(e){
  e.preventDefault();
  var files = Array.from(e.dataTransfer.files);
  var imageFile = files.find(function(f){ return f.type.startsWith('image/'); });
  
  if(imageFile){
    var reader = new FileReader();
    reader.onload = function(e){
      var imageMarkdown = '![' + (imageFile.name || 'imagem') + '](' + e.target.result + ')';
      var start = editor.selectionStart;
      var before = editor.value.substring(0, start);
      var after = editor.value.substring(start);
      editor.value = before + imageMarkdown + after;
      editor.focus();
      render();
    };
    reader.readAsDataURL(imageFile);
  }
});

/* ====== Exportações ====== */
$('#exportPDF').addEventListener('click', function(){ window.print(); });

$('#exportHTML').addEventListener('click', function(){
  var htmlContent = pages.innerHTML;
  var css = Array.from($$('style')).map(function(style){ return style.textContent; }).join('\n');
  
  var fullHtml = '<!DOCTYPE html><html><head><meta charset="utf-8"><title>Documento Exportado</title><style>' + 
                 css + '</style></head><body><div class="a4-surface"><div class="pages">' + 
                 htmlContent + '</div></div></body></html>';
  
  var blob = new Blob([fullHtml], {type: 'text/html'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'documento.html';
  a.click();
  URL.revokeObjectURL(url);
});

$('#downloadMD').addEventListener('click', function(){
  var md = editor.value;
  var blob = new Blob([md], {type: 'text/markdown'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'documento.md';
  a.click();
  URL.revokeObjectURL(url);
});

/* ====== Tema e Estado ====== */
(function(){
  var saved = localStorage.getItem(STORAGE_KEY);
  if(saved !== null) editor.value = saved;
  
  var theme = localStorage.getItem(THEME_KEY) || 'light';
  document.body.className = theme;
  themeBtn.textContent = theme === 'light' ? '🌗' : '☀️';
  
  render();
  setCaretInfo();
  setCountInfo();
})();

themeBtn.addEventListener('click', function(){
  var isLight = document.body.classList.contains('light');
  document.body.classList.toggle('light', !isLight);
  var newTheme = isLight ? 'dark' : 'light';
  localStorage.setItem(THEME_KEY, newTheme);
  themeBtn.textContent = isLight ? '☀️' : '🌗';
  render();
});

/* ====== Eventos do Editor ====== */
editor.addEventListener('input', function(){ render(); setCaretInfo(); });
editor.addEventListener('click', setCaretInfo);
editor.addEventListener('keyup', setCaretInfo);

/* ====== Modal LaTeX ====== */
var latexModal = $('#latexModal');
var latexBtn = $('#latexBtn');
var latexInput = $('#latexInput');
var latexInsert = $('#latexInsert');
var latexCancel = $('#latexCancel');
var latexPreview = $('#latexPreview');
var latexPreviewToggle = $('#latexPreviewToggle');

latexBtn.addEventListener('click', function(){
  var selection = editor.value.substring(editor.selectionStart, editor.selectionEnd);
  latexInput.value = selection || '';
  latexModal.classList.add('open');
  updateLatexPreview();
});

latexInsert.addEventListener('click', function(){
  var kind = $$('input[name="latexKind"]:checked')[0].value;
  var tex = latexInput.value.trim();
  var wrapped = kind === 'inline' ? '$' + tex + '$' : '$$\n' + tex + '\n$$';
  
  var start = editor.selectionStart;
  var end = editor.selectionEnd;
  var before = editor.value.substring(0, start);
  var after = editor.value.substring(end);
  
  editor.value = before + wrapped + after;
  editor.setSelectionRange(start + wrapped.length, start + wrapped.length);
  editor.focus();
  
  latexModal.classList.remove('open');
  render();
});

latexCancel.addEventListener('click', function(){
  latexModal.classList.remove('open');
});

latexInput.addEventListener('input', debounce(updateLatexPreview, 200));
latexPreviewToggle.addEventListener('change', updateLatexPreview);

function updateLatexPreview(){
  if(!latexPreviewToggle.checked){
    latexPreview.innerHTML = '<em>Preview desativado</em>';
    return;
  }
  
  var kind = $$('input[name="latexKind"]:checked')[0].value;
  var tex = latexInput.value.trim();
  
  if(!tex){
    latexPreview.innerHTML = '<em>Digite uma fórmula</em>';
    return;
  }
  
  latexPreview.innerHTML = kind === 'inline' ? '\\( ' + tex + ' \\)' : '\\[ ' + tex + ' \\]';
  
  if(window.MathJax && MathJax.typesetPromise){
    MathJax.typesetPromise([latexPreview]);
  }
}
</script>
</body>
</html>